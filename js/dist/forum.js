(()=>{var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};(()=>{"use strict";e.r(t),e.d(t,{extend:()=>Q,panes:()=>W,types:()=>X});const r=flarum.core.compat["forum/app"];var n=e.n(r);const o=flarum.core.compat["common/extend"],i=flarum.core.compat["common/components/LinkButton"];var a=e.n(i);const s=flarum.core.compat["forum/components/UserPage"];var u=e.n(s);function l(e,t){return l=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},l(e,t)}function d(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,l(e,t)}const c=flarum.core.compat["common/components/LoadingIndicator"];var f=e.n(c);const p=flarum.core.compat["common/Component"];var h=e.n(p);const v=flarum.core.compat["common/helpers/icon"];var y=e.n(v),w=function(){function e(e){var t=e.field,r=e.set,n=e.value;this.field=t,this.set=r,this.value=n}var t=e.prototype;return t.readAttribute=function(e,t){return"function"==typeof e[t]?e[t]():e[t]},t.validationRules=function(){return this.readAttribute(this.field,"validation").split("|")},t.validationRule=function(e){var t=null;return this.validationRules().forEach((function(r){var n=r.split(":",2);n[0]===e&&(t=n[1])})),t},t.editorField=function(){return m("div",{class:"Form-group Field"},m("label",null,this.field.icon()?[y()(this.field.icon())," "]:null," ",this.field.name()," ",this.field.required()?"*":null),m("div",{class:"FormField"},this.field.prefix()?m(".prefix",this.field.prefix()):null,this.editorInput(),this.field.description()?m("div",{class:"helpText"},this.field.description()):null))},t.editorInput=function(){return m("input",this.editorInputAttrs())},t.editorInputAttrs=function(){var e=this;return{className:"FormControl",oninput:function(t){e.set(t.target.value)},value:this.value,required:this.field.required()}},t.answerField=function(){var e=this.readAttribute(this.field,"icon");return m("div",{className:"Masquerade-Bio-Set"+(this.hasAnswer()?"":" Masquerade-Bio-Set--empty")},m("span",{class:"Masquerade-Bio-Field"},e&&m("[",null,y()(e)," "),this.readAttribute(this.field,"name"),":"," "),m("span",{class:"Masquerade-Bio-Answer"},this.answerContent()))},t.answerContent=function(){return this.value},t.hasAnswer=function(){var e=this.answerContent();return!(null===e||("object"==typeof e?!Object.keys(e).length:null==e||!e.length))},e.isNoOptionSelectedValue=function(e){return null===e||""===e},e}(),b=function(e){function t(){return e.apply(this,arguments)||this}d(t,e);var r=t.prototype;return r.editorInput=function(){var e=this;return this.options().map((function(t){return m("div",m("label",[m("input[type=radio]",{checked:t.selected(e.value),onclick:function(){e.set(t.key)}})," "+t.label]))}))},r.options=function(){var e=[];return this.readAttribute(this.field,"required")||e.push({selected:function(e){return w.isNoOptionSelectedValue(e)},key:null,label:app.translator.trans("fof-masquerade.forum.fields.select.none-optional")}),e.push({selected:function(e){return-1!==["true","1",1,!0,"yes"].indexOf(e)},key:"true",label:app.translator.trans("fof-masquerade.forum.fields.boolean.yes")}),e.push({selected:function(e){return-1!==["false","0",0,!1,"no"].indexOf(e)},key:"false",label:app.translator.trans("fof-masquerade.forum.fields.boolean.no")}),w.isNoOptionSelectedValue(this.value)||-1!==["true","1",1,!0,"yes","false","0",0,!1,"no"].indexOf(this.value)||e.push({selected:function(){return!0},key:this.value,label:"(invalid) "+this.value}),e},r.answerContent=function(){return w.isNoOptionSelectedValue(this.value)?"":-1!==[1,"1",!0,"true","yes"].indexOf(this.value)?[y()("far fa-check-square")," ",app.translator.trans("fof-masquerade.forum.fields.boolean.yes")]:[y()("far fa-square")," ",app.translator.trans("fof-masquerade.forum.fields.boolean.no")]},t}(w);const q=flarum.core.compat["common/components/Button"];var g=e.n(q),A=function(e){function t(){return e.apply(this,arguments)||this}d(t,e);var r=t.prototype;return r.editorInputAttrs=function(){var t=e.prototype.editorInputAttrs.call(this);return t.type="email",t.placeholder="you@example.com",t},r.answerContent=function(){var e=this,t=this.value;if(!t)return null;var r=t.split(/@|\./).map((function(e){return e.replace(/(.{2})./g,"$1*")})).join("*");return g().component({onclick:function(){return e.mailTo()},className:"Button Button--text",icon:"far fa-envelope"},r)},r.mailTo=function(){window.location="mailto:"+this.value},t}(w);const F=flarum.core.compat["common/components/Select"];var C=e.n(F),O="fof_masquerade_no_option_selected",P=function(e){function t(){return e.apply(this,arguments)||this}d(t,e);var r=t.prototype;return r.editorInput=function(){var e=this;return C().component({onchange:function(t){t===O&&(t=""),e.set(t)},value:w.isNoOptionSelectedValue(this.value)?O:this.value,options:this.options()})},r.options=function(){var e={};this.readAttribute(this.field,"required")?w.isNoOptionSelectedValue(this.value)&&(e[O]=n().translator.trans("fof-masquerade.forum.fields.select.none-required")):e[O]=n().translator.trans("fof-masquerade.forum.fields.select.none-optional");var t=this.validationRule("in");return t&&t.split(",").forEach((function(t){e[t]=t})),w.isNoOptionSelectedValue(this.value)||void 0!==e[this.value]||(e[this.value]="(invalid) "+this.value),e},t}(w),x=function(e){function t(){return e.apply(this,arguments)||this}d(t,e);var r=t.prototype;return r.editorInputAttrs=function(){var t=e.prototype.editorInputAttrs.call(this);return t.type="url",t.placeholder="https://example.com",t},r.answerContent=function(){var e=this,t=this.value;return t?g().component({onclick:function(){return e.to()},className:"Button Button--text",icon:"fas fa-link"},t.replace(/^https?:\/\//,"")):null},r.to=function(){window.open().location=this.value},t}(w),M=function(){function e(){}return e.typeForField=function(e){var t=e.field,r=e.set,n=void 0===r?void 0:r,o=e.value,i=w,a=this.identify(t);return a&&(i=this.types()[a]),new i({field:t,set:n,value:o})},e.fieldAttribute=function(e,t){return"function"==typeof e[t]?e[t]():e[t]},e.types=function(){return{boolean:b,email:A,select:P,url:x}},e.identify=function(e){var t=this,r=(this.fieldAttribute(e,"validation")||"").split(","),n=null,o=this.fieldAttribute(e,"type");return void 0!==this.types()[o]?o:(r.forEach((function(e){e=e.trim(),void 0!==t.types()[e]&&(n=e)})),n)},e}(),S=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(t=e.call.apply(e,[this].concat(n))||this).answers=void 0,t.user=void 0,t}d(t,e);var r=t.prototype;return r.oninit=function(t){e.prototype.oninit.call(this,t),this.loading=!0,this.answers=[],this.user=this.attrs.user,this.load(this.user)},r.view=function(){var e=this;return m("div",{class:"Masquerade-Bio"},m("div",{class:"Fields"},n().store.all("masquerade-field").sort((function(e,t){return e.sort()-t.sort()})).map((function(t){var r=e.answers.find((function(e){var r;return(null==(r=e.field())?void 0:r.id())===t.id()}));return e.field(t,(null==r?void 0:r.content())||"")}))))},r.field=function(e,t){return M.typeForField({field:e,value:t}).answerField()},r.load=function(){var e=this;this.answers=this.user.masqueradeAnswers(),!1===this.answers&&(this.answers=[],n().store.find("users",this.user.id(),{include:"masqueradeAnswers"}).then((function(){e.answers=e.user.masqueradeAnswers(),m.redraw()}))),m.redraw()},t}(h());const I=flarum.core.compat["common/components/Link"];var V=e.n(I),_=function(e){function t(){return e.apply(this,arguments)||this}d(t,e);var r=t.prototype;return r.oninit=function(t){e.prototype.oninit.call(this,t),this.loading=!0,this.enforceProfileCompletion=n().forum.attribute("masquerade.force-profile-completion")||!1,this.profileCompleted=n().forum.attribute("masquerade.profile-completed")||!1,this.profileNowCompleted=!1,this.answers=[],this.answerValues={},this.user=this.attrs.user,this.load(),this.dirty=!this.profileCompleted},r.view=function(){var e=this;return m("form",{class:"ProfileConfigurePane",onsubmit:this.update.bind(this)},!(!this.enforceProfileCompletion||this.profileCompleted)&&m("div",{class:"Alert Alert--Error"},n().translator.trans("fof-masquerade.forum.alerts.profile-completion-required")),m("div",{class:"Fields"},n().store.all("masquerade-field").sort((function(e,t){return e.sort()-t.sort()})).map((function(t){return e.field(t)}))),m(g(),{type:"submit",className:"Button Button--primary",loading:this.loading,disabled:!this.dirty},n().translator.trans("fof-masquerade.forum.buttons.save-profile")),!!this.profileNowCompleted&&m("span",{class:"Masquerade-NowCompleted"},n().translator.trans("fof-masquerade.forum.alerts.profile-completed",{a:m(V(),{href:n().route("index")})})))},r.field=function(e){return M.typeForField({field:e,set:this.set.bind(this,e),value:this.answerValues[e.id()]}).editorField()},r.load=function(){var e=this;this.answers=this.user.masqueradeAnswers(),!1===this.answers?(this.answers=[],n().store.find("users",this.user.id(),{include:"masqueradeAnswers"}).then((function(){e.answers=e.user.masqueradeAnswers(),e.answerValues={},n().store.all("masquerade-field").forEach((function(t){var r=e.answers.find((function(e){var r;return(null==(r=e.field())?void 0:r.id())===t.id()}));e.answerValues[t.id()]=r?r.content():""})),e.loading=!1,m.redraw()}))):(this.loading=!1,n().store.all("masquerade-field").forEach((function(t){var r=e.answers.find((function(e){var r;return(null==(r=e.field())?void 0:r.id())===t.id()}));e.answerValues[t.id()]=r?r.content():""}))),m.redraw()},r.set=function(e,t){this.answerValues[e.id()]=t,this.dirty=!0},r.update=function(e){var t=this;e.preventDefault(),this.loading=!0,n().request({method:"POST",url:n().forum.attribute("apiUrl")+"/masquerade/configure/"+this.user.id(),body:this.answerValues}).then((function(e){t.dirty=!1,t.profileCompleted||(t.profileCompleted=!0,t.profileNowCompleted=!0),t.parseResponse(e)})).catch((function(){t.loading=!1,m.redraw()}))},r.parseResponse=function(e){console.log(e),this.answers=n().store.pushPayload(e),this.loading=!1,m.redraw()},t}(h()),B=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(t=e.call.apply(e,[this].concat(n))||this).loading=!0,t}d(t,e);var r=t.prototype;return r.oninit=function(t){e.prototype.oninit.call(this,t),this.loadUser(m.route.param("username"))},r.pageContentComponent=function(){return this.user?this.user.canEditMasqueradeProfile()?m(_,{user:this.user}):m(S,{user:this.user}):null},r.show=function(t){e.prototype.show.call(this,t),this.loading=!1,m.redraw()},r.content=function(){return m("div",{class:"MasqueradeRoot"},this.loading&&m(f(),null),this.pageContentComponent())},t}(u());const N=flarum.core.compat["forum/components/UserCard"];var k=e.n(N);const E=flarum.core.compat["common/extenders"];var j=e.n(E);const R=flarum.core.compat["common/models/User"];var T=e.n(R);const U=flarum.core.compat["common/app"];var L=e.n(U);const D=flarum.core.compat["common/Model"];var z=e.n(D);const $=flarum.core.compat["common/utils/computed"];var G=e.n($),H=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(t=e.call.apply(e,[this].concat(n))||this).content=z().attribute("content"),t.fieldId=z().attribute("fieldId"),t.field=G()("fieldId",(function(e){return L().store.getById("masquerade-field",e)})),t.userId=z().attribute("user_id"),t}return d(t,e),t}(z()),J=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(t=e.call.apply(e,[this].concat(n))||this).name=z().attribute("name"),t.description=z().attribute("description"),t.type=z().attribute("type"),t.validation=z().attribute("validation"),t.required=z().attribute("required"),t.prefix=z().attribute("prefix"),t.icon=z().attribute("icon"),t.sort=z().attribute("sort"),t.deleted_at=z().attribute("deleted_at",z().transformDate),t.answer=z().hasOne("answer"),t.on_bio=z().attribute("on_bio"),t}return d(t,e),t.prototype.apiEndpoint=function(){return"/masquerade/fields"+(this.exists?"/"+this.data.id:"")},t}(z());const K=[(new(j().Store)).add("masquerade-field",J)],Q=[].concat(K,[(new(j().Store)).add("masquerade-answer",H),new(j().Model)(T()).hasMany("bioFields").hasMany("masqueradeAnswers").attribute("canEditMasqueradeProfile")]);var W={ProfileConfigurePane:_,ProfilePane:S,RootMasqueradePane:B},X={BaseField:w,BooleanField:b,EmailField:A,SelectField:P,TypeFactory:M,UrlField:x};n().initializers.add("fof-masquerade",(function(){n().routes["fof-masquerade"]={path:"/u/:username/masquerade",resolver:{onmatch:function(){if(!n().forum.attribute("canViewMasquerade"))throw new Error;return B}}},(0,o.extend)(u().prototype,"navItems",(function(e){if(n().forum.attribute("canViewMasquerade")||this.user.canEditMasqueradeProfile()){var t=this.user.canEditMasqueradeProfile();e.add("masquerade",a().component({href:n().route("fof-masquerade",{username:this.user.slug()}),icon:"far fa-id-card","data-editProfile":t},n().translator.trans("fof-masquerade.forum.buttons."+(t?"edit":"view")+"-profile")),200)}})),(0,o.extend)(k().prototype,"infoItems",(function(e){var t=n().forum.attribute("canViewMasquerade")&&this.attrs.user.bioFields()||[];e.add("masquerade-bio",m("div",null,t.map((function(e){var t=e.attribute("field");return M.typeForField({field:t,value:e.content()}).answerField()}))))}))}))})(),module.exports=t})();
//# sourceMappingURL=forum.js.map